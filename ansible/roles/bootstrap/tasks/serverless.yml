- name: "wait for {{ serverless.eventing.namespace }} to be created"
  kubernetes.core.k8s_info:
    kind: Namespace
    name: "{{ serverless.eventing.namespace }}"
    wait: yes
    wait_sleep: 10
    wait_timeout: 360

- name: Wait until KNative Serving installation is complete
  kubernetes.core.k8s_info:
    api_version: operator.knative.dev/v1alpha1
    kind: KnativeServing
    name: knative-serving
    namespace: knative-serving
  register: r_kn_serving
  retries: 30
  delay: 10
  until:
  - r_kn_serving.resources[0].status.conditions[0].status is defined
  - r_kn_serving.resources[0].status.conditions[0].status == "True"
  - r_kn_serving.resources[0].status.conditions[1].status is defined
  - r_kn_serving.resources[0].status.conditions[1].status == "True"
  - r_kn_serving.resources[0].status.conditions[2].status is defined
  - r_kn_serving.resources[0].status.conditions[2].status == "True"
  - r_kn_serving.resources[0].status.conditions[3].status is defined
  - r_kn_serving.resources[0].status.conditions[3].status == "True"

- name: Render the kafkasource templates
  kubernetes.core.helm_template:
    chart_ref: "{{ helm_charts_dir }}/xraylab/{{ kafkasource.template_dir }}"
    output_dir: "{{ helm_output_dir }}"
    values_files:
      - "{{ pattern_repo_dir}}/values-global.yaml"

- name: Remove the existing kafka service
  kubernetes.core.k8s:
    state: absent
    src: "{{ item }}"
  loop:
    - "{{ helm_output_dir }}/{{ kafkasource.template_dir }}/templates/xray-kafka-risk-assessment-svc.yaml"

- name: Make sure the aws-s3-secret exists
  kubernetes.core.k8s_info:
    kind: Secret
    name: s3-secret-bck
    namespace: xraylab-1
    api_version: v1
    wait: yes
    wait_sleep: 10
    wait_timeout: 360 

- name: Apply the kafkasource manifests
  kubernetes.core.k8s:
    state: present
    src: "{{ item }}"
  loop:
    - "{{ helm_output_dir }}/{{ kafkasource.template_dir }}/templates/xray-kafka-risk-assessment-svc.yaml"
